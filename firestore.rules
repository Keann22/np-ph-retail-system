rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Get the user's roles from their profile document
    function getUserRoles() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }

    // Check if the user has any of the required roles
    function hasAnyRole(requiredRoles) {
      return getUserRoles().hasAny(requiredRoles);
    }
    
    // Check if the user is the owner of the document
    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    // Owner, Admin can manage users
    match /users/{userId} {
      allow read, update: if isOwner(userId) || hasAnyRole(['Owner', 'Admin']);
      allow list: if hasAnyRole(['Owner', 'Admin']);
      allow delete: if hasAnyRole(['Owner', 'Admin']);
      // Any authenticated user can create their own user document upon sign-up, which is handled by a cloud function or server-side logic
      allow create: if request.auth != null && request.auth.uid == userId;
    }

    // Owner, Admin, Sales roles can manage core sales data
    match /orders/{orderId} {
      allow read, list, create, update: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }
    match /orderItems/{itemId} {
      allow read, list, create, update: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }
    match /customers/{customerId} {
      allow read, list, create, update, delete: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }
    match /payments/{paymentId} {
      allow read, list, create: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }
     match /returns/{returnId} {
      allow read, list, create, update: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }
     match /refunds/{refundId} {
      allow read, list, create, update: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }


    // Owner, Admin, Warehouse Manager can manage inventory and suppliers
    match /products/{productId} {
      allow read, list: if request.auth != null;
      allow create, update: if hasAnyRole(['Owner', 'Admin', 'Warehouse Manager']);
      // Only Owner/Admin should be able to delete products to prevent accidents
      allow delete: if hasAnyRole(['Owner', 'Admin']);
    }
    match /inventoryMovements/{movementId} {
      // Create is triggered by other actions, so it needs to be open to relevant roles
      allow create: if hasAnyRole(['Owner', 'Admin', 'Warehouse Manager', 'Sales']);
      allow read, list: if hasAnyRole(['Owner', 'Admin', 'Warehouse Manager']);
    }
     match /suppliers/{supplierId} {
      allow read, list: if request.auth != null;
      allow create, update, delete: if hasAnyRole(['Owner', 'Admin', 'Warehouse Manager']);
    }
    match /categories/{categoryId} {
        allow read, list: if request.auth != null;
        allow create, update, delete: if hasAnyRole(['Owner', 'Admin']);
    }

    // Owner, Admin can manage financials
    match /expenses/{expenseId} {
      allow read, list, create, update, delete: if hasAnyRole(['Owner', 'Admin']);
    }
    match /badDebts/{badDebtId} {
       allow read, list, create, update, delete: if hasAnyRole(['Owner', 'Admin']);
    }
  }
}

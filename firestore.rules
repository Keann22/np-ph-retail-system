rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset implements a strict Role-Based Access Control (RBAC) model
     * for a retail management application. A special "Owner" account, identified by the email
     * 'keneth@owner.com', has universal god-mode access to all data. For all other users,
     * access is determined by a `roleId` stored on their user profile document in the `/users`
     * collection. This role dictates their permissions for viewing and modifying business-related
     * data collections like products, orders, and customers.
     *
     * Data Structure: The data is organized into a flat hierarchy of top-level collections
     * (e.g., /products, /orders, /customers). User-specific profile data is stored under
     * `/users/{userId}`, where the document ID matches the user's Firebase Authentication UID.
     *
     * Key Security Decisions:
     * - A hardcoded super-admin ('Owner') is implemented as per user requirements for full administrative control.
     * - All other data access relies on checking the authenticated user's profile document (`/users/{userId}`) to retrieve their role.
     * - User listing is explicitly disallowed to protect user privacy and prevent data scraping.
     * - Users can create their own profile document upon signup but cannot modify their own role; role management is reserved for Admins and the Owner.
     *
     * Denormalization for Authorization: The primary authorization strategy relies on a `get()` call
     * within the rules to fetch the user's role from `/users/{request.auth.uid}`. This centralized
     * approach is used because roles are not denormalized onto every business document. While this
     * adds a read operation to each request, it simplifies role management significantly.
     *
     * Structural Segregation: Each data entity (Products, Orders, Customers, etc.) is stored in its
     * own top-level collection. This ensures that a single, consistent set of security rules applies
     * to all documents of the same type, making the rules easier to understand and manage.
     */

    // --------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated via Firebase Auth.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user is the special Owner account.
     * This grants god-mode access across the entire database.
     */
    function isOwnerAccount() {
      return isSignedIn() && request.auth.token.email == 'keneth@owner.com';
    }

    /**
     * Checks if the document's ID matches the authenticated user's UID.
     * Used to verify ownership of a user-specific document.
     * @param userId The UID from the document path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Verifies that a document already exists.
     * CRITICAL for all update and delete operations to prevent acting on non-existent data.
     */
    function isExistingDoc() {
      return resource != null;
    }
    
    /**
     * Retrieves the authenticated user's profile document from the `/users` collection.
     * This is the central piece of the RBAC system.
     */
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    /**
     * Checks if the authenticated user has any of the specified roles.
     * This function is robust against non-existent user profile documents.
     * @param allowedRoles A map where keys are the role names (e.g., {'admin': true}).
     */
    function hasAnyRole(allowedRoles) {
      // 1. Ensure user is authenticated.
      if (!isSignedIn()) {
        return false;
      }
      
      // 2. Get the user's profile document.
      let userDoc = getUserData();
      
      // 3. IMPORTANT: Check if the document actually exists. If not, access is denied.
      // This prevents errors if a user is authenticated but has no profile document.
      if (!userDoc.exists) {
        return false;
      }
      
      // 4. Safely access the roleId from the document's data.
      let userRoleId = userDoc.data.roleId;
      
      // 5. Check if the user's role is in the map of allowed roles.
      return userRoleId in allowedRoles;
    }

    /**
     * Validates that the user is creating their own user profile document.
     * Ensures the document's internal `id` field matches the user's auth UID.
     */
    function isCreatingOwnUserDoc(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Validates that a user is updating their own profile while preserving immutable fields.
     * A user cannot change their own `id` or `roleId`.
     */
    function isUpdatingOwnProfileData(userId) {
      return isOwner(userId)
        && request.resource.data.id == resource.data.id
        && request.resource.data.roleId == resource.data.roleId;
    }

    // --------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------

    match /users/{userId} {
      allow read, write: if isOwnerAccount();
      allow get: if isOwner(userId) || hasAnyRole({'admin': true, 'owner': true});
      allow list: if false;
      allow create: if isCreatingOwnUserDoc(userId);
      allow update: if isExistingDoc() && (hasAnyRole({'admin': true, 'owner': true}) || isUpdatingOwnProfileData(userId));
      allow delete: if isExistingDoc() && hasAnyRole({'admin': true, 'owner': true});
    }

    match /roles/{roleId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if isSignedIn();
      allow create, update, delete: if isExistingDoc() && hasAnyRole({'admin': true, 'owner': true});
    }

    match /products/{productId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if hasAnyRole({'sales': true, 'admin': true, 'owner': true, 'warehouse_manager': true});
      allow create: if hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
    }

    match /categories/{categoryId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if hasAnyRole({'sales': true, 'admin': true, 'owner': true, 'warehouse_manager': true});
      allow create: if hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
    }

    match /inventoryMovements/{inventoryMovementId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
      allow create: if hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
    }

    match /customers/{customerId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if isSignedIn();
      allow create: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true});
    }
    
    match /orders/{orderId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if isSignedIn();
      allow create: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true});
    }
    
    match /orderItems/{orderItemId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow create: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true});
    }
    
    match /payments/{paymentId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow create: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true});
    }

    match /expenses/{expenseId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if hasAnyRole({'admin': true, 'owner': true});
      allow create: if hasAnyRole({'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'admin': true, 'owner': true});
    }
    
    match /returns/{returnId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow create: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true});
    }

    match /refunds/{refundId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow create: if hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true});
    }

    match /badDebts/{badDebtId} {
      allow read, write: if isOwnerAccount();
      allow get, list: if hasAnyRole({'admin': true, 'owner': true});
      allow create: if hasAnyRole({'admin': true, 'owner': true});
      allow update, delete: if isExistingDoc() && hasAnyRole({'admin': true, 'owner': true});
    }
  }
}

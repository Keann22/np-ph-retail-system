rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwnerAccount() {
      return isSignedIn() && request.auth.token.email == 'keneth@owner.com';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingDoc() {
      return resource != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function hasAnyRole(allowedRoles) {
      if (!isSignedIn()) {
        return false;
      }
      let userDoc = getUserData();
      if (!userDoc.exists) {
        return false;
      }
      let userRoleId = userDoc.data.roleId;
      return userRoleId in allowedRoles;
    }

    function isCreatingOwnUserDoc(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    function isUpdatingOwnProfileData(userId) {
      return isOwner(userId)
        && request.resource.data.id == resource.data.id
        && request.resource.data.roleId == resource.data.roleId;
    }

    // --- TEMPORARY WIDE-OPEN READ ACCESS ---
    // The following rule grants read access (get, list) to any signed-in user 
    // for ALL collections. This is a temporary measure to resolve persistent 
    // permission errors and unblock development.
    match /{document=**} {
      allow read: if isSignedIn();
    }
    
    // --- WRITE RULES ---
    // Write rules remain more restrictive to protect data integrity.

    match /users/{userId} {
      // The broad read rule above covers 'get', but we must explicitly deny 'list'.
      allow list: if false; 
      allow create: if isCreatingOwnUserDoc(userId);
      allow update: if isOwnerAccount() || (isExistingDoc() && (hasAnyRole({'admin': true, 'owner': true}) || isUpdatingOwnProfileData(userId)));
      allow delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'admin': true, 'owner': true}));
    }

    match /roles/{roleId} {
      allow create, update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'admin': true, 'owner': true}));
    }

    match /products/{productId} {
      allow create: if isOwnerAccount() || hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true}));
    }

    match /categories/{categoryId} {
      allow create: if isOwnerAccount() || hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true}));
    }

    match /inventoryMovements/{inventoryMovementId} {
      allow create: if isOwnerAccount() || hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'warehouse_manager': true, 'admin': true, 'owner': true}));
    }

    match /customers/{customerId} {
      allow create: if isOwnerAccount() || hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true}));
    }
    
    match /orders/{orderId} {
      allow create: if isOwnerAccount() || hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true}));
    }
    
    match /orderItems/{orderItemId} {
      allow create: if isOwnerAccount() || hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true}));
    }
    
    match /payments/{paymentId} {
      allow create: if isOwnerAccount() || hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true}));
    }

    match /expenses/{expenseId} {
      allow create: if isOwnerAccount() || hasAnyRole({'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'admin': true, 'owner': true}));
    }
    
    match /returns/{returnId} {
      allow create: if isOwnerAccount() || hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true}));
    }

    match /refunds/{refundId} {
      allow create: if isOwnerAccount() || hasAnyRole({'sales': true, 'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'sales': true, 'admin': true, 'owner': true}));
    }

    match /badDebts/{badDebtId} {
      allow create: if isOwnerAccount() || hasAnyRole({'admin': true, 'owner': true});
      allow update, delete: if isOwnerAccount() || (isExistingDoc() && hasAnyRole({'admin': true, 'owner': true}));
    }
  }
}

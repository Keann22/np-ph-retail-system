rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to check user roles.
    // This reduces code duplication and improves readability.
    function getUserData() {
      // Securely get the current user's document data.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isLoggedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
        return request.auth.uid == userId;
    }
    
    function hasAnyRole(roles) {
      // Check if the user has any of the roles in the provided list.
      return isLoggedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && getUserData().roles.hasAny(roles);
    }
    
    // User profiles can be managed by Admins/Owners, or by the users themselves.
    match /users/{userId} {
      // A user can create their own profile, read it, and update it.
      allow get, update: if isLoggedIn() && isOwner(userId);
      allow create: if isLoggedIn() && isOwner(userId);
      // Admins and Owners have full access to manage all user profiles.
      // Any logged-in user can perform the 'is first user' check to get assigned the Owner role.
      allow list: if hasAnyRole(['Owner', 'Admin']) || (isLoggedIn() && request.query.limit <= 1);
      allow delete: if hasAnyRole(['Owner', 'Admin']);
    }
    
    match /products/{productId} {
      // All authenticated users can see products. Only managers can edit them.
      allow read: if isLoggedIn();
      allow write: if hasAnyRole(['Owner', 'Admin', 'Warehouse Manager']);
    }

    match /categories/{categoryId} {
      allow read: if isLoggedIn();
      allow write: if hasAnyRole(['Owner', 'Admin', 'Warehouse Manager']);
    }

    match /inventoryMovements/{inventoryMovementId} {
      // Only managers can see and write inventory history.
      allow read, write: if hasAnyRole(['Owner', 'Admin', 'Warehouse Manager']);
    }
    
    match /customers/{customerId} {
      // Sales team and admins can manage customers.
      allow read, write: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }
    
    match /orders/{orderId} {
      // Sales team and admins can manage orders.
      allow read, write: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }
    
    match /orderItems/{orderItemId} {
      // Sales team and admins can manage order items, which are linked to orders.
      allow read, write: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }

    match /payments/{paymentId} {
      // Sales team and admins can manage payments.
      allow read, write: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }

    match /expenses/{expenseId} {
      // Only Owners and Admins can manage financial expenses.
      allow read, write: if hasAnyRole(['Owner', 'Admin']);
    }

    match /returns/{returnId} {
      // Sales team and admins can manage returns.
      allow read, write: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }
    
    match /refunds/{refundId} {
      // Sales team and admins can manage refunds.
      allow read, write: if hasAnyRole(['Owner', 'Admin', 'Sales']);
    }

    match /badDebts/{badDebtId} {
      // Only Owners and Admins can write off bad debts.
      allow read, write: if hasAnyRole(['Owner', 'Admin']);
    }

    match /suppliers/{supplierId} {
      // Only managers can view and edit supplier information.
      allow read, write: if hasAnyRole(['Owner', 'Admin', 'Warehouse Manager']);
    }
  }
}
